#!/usr/bin/env node
var fs = require('fs'),
    path = require('path'),
    Glue = require('../index.js');

var opts = require('yargs')
    .usage('Usage: $0 --include <file/dir ...> --out filename.js')
    .options({
      'amd': { },
      'basepath': { 'default': process.cwd() },
      'cache': { default: true },
      'cache-path': { },
      'config': { },
      'command': { },
      'exclude': { },
      'exclude-regexp': { },
      'global': { },
      'global-require': { },
      'include': { },
      'ignore': { },
      'jobs': { },
      'main': { 'default': 'index.js' },
      'out': { },
      'parse': { },
      'remap': { },
      'replace': { },
      'reset-exclude': { },
      'silent': { },
      'source-url': { },
      'verbose': { },
      'version': { }
    })
    .boolean('cache')
    .boolean('report')
    .boolean('progress')
    .boolean('verbose')
    .boolean('parse')
    .boolean('export-config'),
    argv = opts.parse(process.argv);

if(argv['version'] || argv['v'] ) {
  console.log(require('../package.json').version);
  process.exit();
}

var g = new Glue(),
    config = {};

if (argv['config']) {
  argv.config = path.resolve(process.cwd(), argv['config']);
  if (fs.existsSync(argv.config)) {
    config = require(argv.config);
    g.set(config);
    if(config['out']) {
      g.render(fs.createWriteStream(config['out']));
    } else {
      g.render(process.stdout);
    }
    return;
  } else {
    console.log('Failed to load config file:', argv.config);
    process.exit(1);
  }
}

if(!argv['include']) {
  return fs.createReadStream(__dirname + '/usage.txt').pipe(process.stdout).on('close', function () { process.exit(1) });
}

// set logging levels early, so that all messages are shown
// Logging level (exclusive):
// --verbose: Enable verbose logging
// --debug: Enable debug logging
var logLevel = 'warn';
if (argv['verbose']) {
  logLevel = 'info';
}
if (argv['debug']) {
  logLevel = 'debug';
}
if (argv['silent']) {
  logLevel = 'error';
}
config['log'] = logLevel;

// Logging reporters:
// --silent: no reporter
// --progress: progress report (enabled by default)
// --report: size report
// --list: file list, disables others

if (argv['silent']) {
  // no reporters
} else if (argv['list']) {
  config['list'] = true;
  config['log'] = 'error';
} else {
  ['progress', 'report'].forEach(function(key) {
    if (typeof argv[key] !== 'undefined') {
      config[key] = argv[key];
    }
  });
  // if --out filename and not --silent, enable the progress reporter
  if (argv['out'] && process.stderr.isTTY && !(logLevel == 'debug' || logLevel == 'info')) {
    config['progress'] = true;
  }
}

// Boolean params:
// --reset-exclude
// --source-url
// --global-require
// --parse
// --cache
[ 'reset-exclude', 'source-url', 'global-require', 'parse', 'debug', 'verbose',
  'cache' ].forEach(function(key) {
  config[key] = !!argv[key];
});

// Allow the following params to be specified with a ,
// Also accept multiple param groups: --foo a,b,c --foo d,e,f
[ 'include', 'exclude', 'ignore', 'remap', 'replace'].forEach(function(key) {
  if (!argv[key]) {
    return;
  }
  argv[key] = (Array.isArray(argv[key]) ? argv[key] : [ argv[key] ]).reduce(function(prev, curr) {
    return prev.concat(curr.split(','));
  }, []);
});

// String params:
// --include
// --exclude
// --basepath
// --main
// --ignore
// --amd
// --umd
// --cache-method
// --command
// --transform
// --jobs
// --log

[ 'include', 'exclude', 'basepath', 'main', 'ignore',
  'amd', 'umd', 'cache-method',
  'command', 'transform', 'jobs',
  'log', 'out', 'exclude-regexp'].forEach(function(key) {
  if(argv[key]) {
    config[key] = argv[key];
  }
});

// --global
config['export'] = argv['global'];

// --remap
['replace', 'remap'].forEach(function(key) {
  if (!argv[key]) {
    return;
  }
  // allow --remap foo=bar,baz=abc or --remap foo=bar --remap bar=abc
  var values = {};

  argv[key].forEach(function(item) {
    var pos = item.indexOf('='),
        name = item.substring(0, pos),
        value = item.substring(pos+1);
    values[name] = value;
  });
  if (Object.keys(values).length > 0) {
    config[key] = values;
  }
});

if(argv['cache-path']) {
  config['cache-path'] = path.resolve(process.cwd(), argv['cache-path']);
}

if(argv['npm']) {
  process.stderr.write('Warning: the --npm flag is deprecated. ' +
    'Directly include the file path to module, e.g. --include ./node_modules/foo instead.\n');
}


if(argv['export-config']) {
  console.log(JSON.stringify(config, null, 2));
  process.exit();
}

// set this so that builds are invalidated as the version changes
config['gluejs-version'] = require('../package.json').version;

g.set(config);

// -- out
if(config['out']) {
  g.render(fs.createWriteStream(config['out']));
} else {
  g.render(process.stdout);
}
